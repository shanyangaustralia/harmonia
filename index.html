<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Harmonia ‚Ä¢ Progressive Electronic Music Therapy</title>
<style>
  :root{
    --bg1:#5b2bbf; --bg2:#9f7aea; --card:#1e1633; --text:#f6f3ff; --muted:#cfc6ff;
    --accent:#ffd166; --accent-2:#5df2d6; --danger:#ff7a7a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    color:var(--text);
    background: radial-gradient(1200px 700px at 10% 10%, var(--bg2), transparent 60%),
                radial-gradient(1200px 700px at 90% 0%, #7f56d9, transparent 60%),
                linear-gradient(160deg, #2b164f 0%, #120a27 60%);
  }
  .container{max-width:1100px;margin:0 auto;padding:24px}
  header{
    display:flex;align-items:center;justify-content:space-between;gap:16px;
    padding:16px 0 8px 0;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .logo{
    width:40px;height:40px;border-radius:50%;
    background: conic-gradient(from 120deg, var(--accent), var(--accent-2), #a78bfa);
    box-shadow:0 0 12px #a78bfaaa, inset 0 0 12px #ffffff22;
  }
  h1{font-size:clamp(22px, 4vw, 32px); margin:0}
  .sub{color:var(--muted); margin:4px 0 0 0; font-size:14px}
  .card{
    background:rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.08);
    border-radius:18px; padding:18px;
    box-shadow:0 6px 30px rgba(0,0,0,.25);
    backdrop-filter: blur(6px);
  }
  .hero{display:grid;grid-template-columns:1.1fr .9fr;gap:18px;align-items:stretch}
  @media (max-width:900px){.hero{grid-template-columns:1fr}}
  .btn{
    appearance:none; border:none; cursor:pointer; color:#131218; font-weight:700;
    padding:12px 16px; border-radius:12px; background:var(--accent);
    transition:transform .05s ease, box-shadow .2s ease;
    box-shadow:0 6px 20px rgba(255,209,102,.35);
  }
  .btn:is(:hover,:focus){transform:translateY(-1px)}
  .btn.secondary{background:#ffffff12;color:var(--text);border:1px solid #ffffff22;box-shadow:none}
  .btn.ghost{background:transparent;color:var(--text);border:1px dashed #ffffff35}
  .stack{display:flex;gap:10px;flex-wrap:wrap}
  .moods{display:flex;gap:10px;flex-wrap:wrap}
  .chip{
    border:1px solid #ffffff2a; padding:8px 12px; border-radius:999px; cursor:pointer; user-select:none;
    background:#ffffff10; color:var(--text); font-weight:600; font-size:14px;
  }
  .chip[data-active="true"]{background:var(--accent-2); color:#13201c; border-color:transparent}
  .panel{display:grid; gap:12px}
  .grid{display:grid; grid-template-columns: repeat( auto-fill, minmax(240px,1fr) ); gap:14px}
  .track{
    display:grid; gap:8px; align-content:start;
    padding:12px; border-radius:14px; background:rgba(255,255,255,0.04); border:1px solid #ffffff14;
  }
  .track img{width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:10px}
  .track h4{margin:6px 0 0 0; font-size:16px}
  .track p{margin:0;color:var(--muted); font-size:13px}
  .row{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
  .small{font-size:12px;color:var(--muted)}
  footer{margin:30px 0; text-align:center; color:#bfb3ff}
  .notice{font-size:12px; color:#d7cdfa}
  .hidden{display:none !important}
  .ok{color:#7bf7c8}
  .bad{color:var(--danger)}
  textarea, select, input[type="text"]{
    width:100%; background:#0f0a20; color:var(--text); border:1px solid #ffffff21; border-radius:10px; padding:10px;
  }
  label{font-size:13px;color:#dfd8ff}
  .rating{display:flex; gap:6px}
  .rating button{
    width:34px;height:34px;border-radius:10px;border:1px solid #ffffff2a;background:#ffffff10;color:var(--text);cursor:pointer
  }
  .rating button[data-active="true"]{background:var(--accent); color:#1a142e; border-color:transparent; font-weight:800}
  .pill{padding:6px 10px;border-radius:999px;background:#ffffff12;border:1px solid #ffffff22}
  .muted{opacity:.8}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Harmonia</h1>
          <div class="sub">Progressive electronic playlists for mood, focus, and calm.</div>
        </div>
      </div>
      <div class="stack">
        <button id="connectBtn" class="btn">üîó Connect to Spotify</button>
        <span id="authState" class="pill muted">Not connected</span>
      </div>
    </header>

    <section class="hero">
      <div class="card panel">
        <h2 style="margin:0">Start a session</h2>
        <p class="small">Choose your current goal. We‚Äôll recommend tracks to match your mood.</p>

        <div id="moodChips" class="moods">
          <!-- mood chips populated by JS -->
        </div>

        <div class="row">
          <button id="recommendBtn" class="btn secondary" disabled>‚ú® Get Recommendations</button>
          <span class="notice">Tip: Connect to Spotify first for live, personalized results.</span>
        </div>

        <div id="demoNote" class="small hidden">Running in <strong>demo mode</strong> (no Spotify token). You‚Äôll see sample embeds.</div>
      </div>

      <div class="card panel">
        <h3 style="margin:0">Session Settings</h3>
        <label for="tracksCount">How many tracks? (5‚Äì12)</label>
        <input id="tracksCount" type="number" min="5" max="12" value="8" />
        <label for="durationPref">Session vibe</label>
        <select id="durationPref">
          <option value="balanced" selected>Balanced</option>
          <option value="chill">Chill / low energy</option>
          <option value="focus">Deep focus</option>
          <option value="energize">Energize</option>
        </select>
        <p class="small">We tune energy & valence to your selection.</p>
      </div>
    </section>

    <section id="results" class="panel" style="margin-top:18px">
      <div class="row">
        <h2 style="margin:0">Recommendations</h2>
        <span id="countBadge" class="pill muted hidden"></span>
      </div>
      <div id="tracks" class="grid"></div>
    </section>

    <section id="feedback" class="card panel hidden">
      <div class="row">
        <h3 style="margin:0">How was your session?</h3>
        <span class="small">We‚Äôd love your feedback.</span>
      </div>
      <div class="rating" id="rating">
        <!-- rating buttons -->
      </div>
      <label for="fbTxt" style="margin-top:8px">Comments (optional)</label>
      <textarea id="fbTxt" rows="3" placeholder="Tell us what worked or what to improve‚Ä¶"></textarea>
      <div class="row">
        <button id="submitFb" class="btn">Send Feedback</button>
        <span id="fbMsg" class="small"></span>
      </div>
    </section>

    <footer>
      <div class="small">Built for your prototype. No personal data stored‚Äîfeedback stays in your browser.</div>
    </footer>
  </div>

<script>
/* =========================
   CONFIG
========================= */
const SPOTIFY_CLIENT_ID = "PASTE_YOUR_SPOTIFY_CLIENT_ID_HERE"; // ‚Üê REQUIRED for live API
const SCOPES = []; // Recommendations need no special scope
const REDIRECT_URI = (() => {
  // use exact current URL without hash/query to simplify OneCompiler runs
  const loc = window.location;
  return loc.origin + loc.pathname;
})();

/* =========================
   STATE
========================= */
const state = {
  token: null,
  tokenExp: 0,
  mood: "relax",
  rating: 0,
};

const moods = [
  { id:"relax", label:"Relax", seeds:["ambient","chill","new-age"], energy:0.25, valence:0.55 },
  { id:"focus", label:"Focus", seeds:["ambient","chill","electronic"], energy:0.35, valence:0.45 },
  { id:"energize", label:"Energize", seeds:["dance","edm","trance"], energy:0.75, valence:0.65 },
  { id:"uplift", label:"Uplift", seeds:["pop","electropop","indie-pop"], energy:0.6, valence:0.85 },
  { id:"sleep", label:"Sleep", seeds:["ambient","sleep","piano"], energy:0.15, valence:0.35 },
];

/* =========================
   UTIL
========================= */
function $(sel){return document.querySelector(sel)}
function el(tag, attrs={}, children=[]){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==="class") e.className=v; else if(k==="html") e.innerHTML=v; else e.setAttribute(k,v);
  });
  (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>{
    if(typeof c==="string") e.appendChild(document.createTextNode(c));
    else e.appendChild(c);
  });
  return e;
}
function setAuthState(connected){
  $("#authState").textContent = connected ? "Connected to Spotify" : "Not connected";
  $("#authState").classList.toggle("ok", connected);
  $("#authState").classList.toggle("bad", !connected);
  $("#recommendBtn").disabled = !connected;
  $("#demoNote").classList.toggle("hidden", connected);
}
function parseHashToken(){
  if(window.location.hash.startsWith("#")){
    const params = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = params.get("access_token");
    const expiresIn = Number(params.get("expires_in") || 0);
    if(accessToken){
      state.token = accessToken;
      state.tokenExp = Date.now() + expiresIn*1000 - 5000; // small buffer
      // clean hash for a nicer URL
      history.replaceState(null, "", REDIRECT_URI);
      return true;
    }
  }
  return false;
}

/* =========================
   AUTH
========================= */
function connectSpotify(){
  if(!SPOTIFY_CLIENT_ID || SPOTIFY_CLIENT_ID.includes("PASTE_")){
    alert("Add your Spotify Client ID in the code (SPOTIFY_CLIENT_ID) to connect.");
    return;
  }
  const authUrl = new URL("https://accounts.spotify.com/authorize");
  authUrl.searchParams.set("client_id", SPOTIFY_CLIENT_ID);
  authUrl.searchParams.set("response_type", "token");
  authUrl.searchParams.set("redirect_uri", REDIRECT_URI);
  authUrl.searchParams.set("scope", SCOPES.join(" "));
  authUrl.searchParams.set("show_dialog", "true");
  // Optional: store CSRF 'state' (skipped here for brevity)
  window.location.assign(authUrl.toString());
}

async function spotifyGET(path, params={}){
  if(!state.token || Date.now() > state.tokenExp) throw new Error("No valid token");
  const url = new URL("https://api.spotify.com/v1/" + path.replace(/^\/+/,""));
  Object.entries(params).forEach(([k,v])=> url.searchParams.set(k,String(v)));
  const res = await fetch(url.toString(), { headers: { Authorization: `Bearer ${state.token}` }});
  if(!res.ok){
    const txt = await res.text();
    throw new Error(`Spotify error ${res.status}: ${txt}`);
  }
  return res.json();
}

/* =========================
   UI: moods
========================= */
function renderMoods(){
  const wrap = $("#moodChips");
  wrap.innerHTML = "";
  moods.forEach(m=>{
    const chip = el("button", {class:"chip", "data-id":m.id});
    chip.textContent = m.label;
    chip.onclick = ()=>{
      state.mood = m.id;
      [...wrap.children].forEach(c=>c.setAttribute("data-active", String(c===chip)));
    };
    chip.setAttribute("data-active", m.id===state.mood);
    wrap.appendChild(chip);
  });
}

/* =========================
   RECOMMENDATIONS
========================= */
function settingsForMood(id){
  const base = moods.find(m=>m.id===id) || moods[0];
  // allow user ‚Äúvibe‚Äù override
  const pref = $("#durationPref").value;
  let energy = base.energy, valence = base.valence;
  if(pref==="chill"){ energy = Math.max(0.1, base.energy-0.15); valence = Math.min(0.7, base.valence) }
  if(pref==="focus"){ energy = 0.35; valence = 0.45 }
  if(pref==="energize"){ energy = Math.min(0.95, base.energy+0.2); valence = Math.max(0.55, base.valence) }
  return { seeds: base.seeds.slice(0,3).join(","), energy, valence };
}

async function getRecommendations(){
  const n = Math.max(5, Math.min(12, Number($("#tracksCount").value)||8));
  const { seeds, energy, valence } = settingsForMood(state.mood);
  const params = {
    limit: n,
    seed_genres: seeds,
    target_energy: energy,
    target_valence: valence,
    market: "US"
  };

  $("#tracks").innerHTML = "";
  $("#countBadge").classList.add("hidden");

  if(!state.token){
    // DEMO: fallback to showing an embedded playlist by mood
    const moodToPlaylist = {
      relax: "37i9dQZF1DX7EF8wVxBVhG", // Peaceful Piano (example)
      focus: "37i9dQZF1DXc8kgYqQLMfH", // Deep Focus
      energize: "37i9dQZF1DX8FwnYE6PRvL", // Dance Rising
      uplift: "37i9dQZF1DX0UrRvztWcAU", // Feel Good
      sleep: "37i9dQZF1DWZd79rJ6a7lp"  // Sleep
    };
    const pid = moodToPlaylist[state.mood] || moodToPlaylist.relax;
    $("#tracks").appendChild(el("div",{class:"card"},[
      el("h4",{style:"margin:0 0 8px 0"}, "Demo preview"),
      el("p",{class:"small"}, "Connect to Spotify for live, personalized tracks. Showing a sample playlist embed:"),
      el("div",{html:`<iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/${pid}" width="100%" height="400" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>`})
    ]));
    showFeedback();
    return;
  }

  try{
    const data = await spotifyGET("recommendations", params);
    const tracks = data.tracks || [];
    renderTracks(tracks);
    $("#countBadge").textContent = `${tracks.length} tracks`;
    $("#countBadge").classList.remove("hidden");
    showFeedback();
  }catch(err){
    console.error(err);
    $("#tracks").appendChild(el("div",{class:"card"},[
      el("h4",{style:"margin:0"},"Couldn‚Äôt load recommendations"),
      el("p",{class:"small"},"Try reconnecting to Spotify. If you‚Äôre in OneCompiler, ensure the Client ID is set.")
    ]));
  }
}

function renderTracks(tracks){
  const grid = $("#tracks");
  grid.innerHTML = "";
  if(!tracks.length){
    grid.appendChild(el("div",{class:"small"},"No tracks found. Try another mood."));
    return;
  }
  tracks.forEach(t=>{
    const img = t.album?.images?.[0]?.url || "";
    const artist = (t.artists||[]).map(a=>a.name).join(", ");
    const openUrl = t.external_urls?.spotify || "#";
    const preview = t.preview_url;

    const card = el("div",{class:"track"},[
      el("img",{src:img, alt:`${t.name} album art`}),
      el("h4",{}, t.name),
      el("p",{}, artist),
      preview ? el("audio",{controls:true, src:preview}) : el("p",{class:"small muted"},"Preview unavailable"),
      el("a",{href:openUrl, target:"_blank", rel:"noopener", class:"btn ghost"}, "Open in Spotify")
    ]);
    grid.appendChild(card);
  });
}

/* =========================
   FEEDBACK
========================= */
function renderRating(){
  const wrap = $("#rating"); wrap.innerHTML = "";
  for(let i=1;i<=5;i++){
    const b = el("button",{"data-val":i, "aria-label":`Rate ${i}`}, String(i));
    b.onclick = ()=>{
      state.rating = i;
      [...wrap.children].forEach(c=>c.setAttribute("data-active", String(c===b)));
    };
    wrap.appendChild(b);
  }
}
function showFeedback(){
  renderRating();
  $("#feedback").classList.remove("hidden");
}
function saveFeedback(){
  const fb = {
    ts: new Date().toISOString(),
    mood: state.mood,
    rating: state.rating,
    text: $("#fbTxt").value.trim()
  };
  if(!fb.rating){
    $("#fbMsg").textContent = "Please choose a rating (1‚Äì5).";
    return;
  }
  const key = "harmonia_feedback";
  const list = JSON.parse(localStorage.getItem(key) || "[]");
  list.push(fb);
  localStorage.setItem(key, JSON.stringify(list));
  $("#fbMsg").textContent = "Thanks! Your feedback was saved locally.";
}

/* =========================
   INIT
========================= */
function init(){
  renderMoods();
  renderRating();
  const got = parseHashToken();
  setAuthState(got);

  $("#connectBtn").addEventListener("click", connectSpotify);
  $("#recommendBtn").addEventListener("click", getRecommendations);
  $("#submitFb").addEventListener("click", saveFeedback);

  // enable demo if no token, still allow recommendations (with embed)
  if(!state.token){
    $("#recommendBtn").disabled = false;
    $("#demoNote").classList.remove("hidden");
  }
}
init();
</script>
</body>
</html>
